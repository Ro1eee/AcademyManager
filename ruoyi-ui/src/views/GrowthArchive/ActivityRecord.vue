<template>
  <div class="container">
    <div class="main-container">
      <!-- È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
      <div class="nav">
        <div class="nav-content">
          <h2>
            <span class="activity-icon">üé®</span>
            Êñá‰ΩìÊ¥ªÂä®ËÆ∞ÂΩï
            <span class="current-semester">{{ activeSemester }} Ê¥ªÂä®ÊàêÊûú</span>
          </h2>
          <el-button
            type="primary"
            class="add-button"
            @click="openDialog"
            icon="el-icon-plus"
          >Êñ∞Â¢ûËÆ∞ÂΩï
          </el-button>
        </div>
      </div>

      <!-- Ê¥ªÂä®Ë°®Ê†º -->
      <div class="activity-table-card">
        <el-table
          :data="activityRecords"
          style="width: 100%"
          class="optimized-table"
          :header-cell-style="headerStyle"
          v-loading="loading"
          :row-class-name="tableRowClassName"
        >
          <!-- Â∫èÂè∑Âàó -->
          <el-table-column label="Â∫èÂè∑" width="80" align="center">
            <template v-slot="scope">
              <span class="index-badge">
                {{ (currentPage - 1) * pageSize + scope.$index + 1 }}
              </span>
            </template>
          </el-table-column>

          <!-- Ê¥ªÂä®ÂêçÁß∞ -->
          <el-table-column prop="activityName" label="Ê¥ªÂä®ÂêçÁß∞" min-width="120">
            <template v-slot="scope">
              <div class="activity-name">
                <i class="el-icon-star-on name-icon"></i>
                <span class="name-text">{{ scope.row.activityName }}</span>
              </div>
            </template>
          </el-table-column>

          <!-- Ê¥ªÂä®Á∫ßÂà´ -->
          <el-table-column prop="activityLevel" label="Ê¥ªÂä®Á∫ßÂà´" width="120" align="center">
            <template v-slot="scope">
              <el-tag
                :type="getLevelTagType(scope.row.activityLevel)"
                effect="light"
                class="level-tag"
              >
                {{ scope.row.activityLevel }}
              </el-tag>
            </template>
          </el-table-column>

          <!-- Ëé∑Â•ñÁ≠âÁ∫ß -->
          <el-table-column prop="awardLevel" label="Ëé∑Â•ñÁ≠âÁ∫ß" width="120" align="center">
            <template v-slot="scope">
              <el-tag
                :type="getAwardTagType(scope.row.awardLevel)"
                effect="light"
                class="award-tag"
              >
                {{ scope.row.awardLevel }}
              </el-tag>
            </template>
          </el-table-column>

          <!-- Ëé∑Â•ñÊó•Êúü -->
          <el-table-column prop="awardDate" label="Ëé∑Â•ñÊó•Êúü" width="120" align="center">
            <template v-slot="scope">
              <span class="time-display">
                {{ formatDate(scope.row.awardDate) }}
              </span>
            </template>
          </el-table-column>

          <!-- ËØÅÊòéÊùêÊñô -->
          <el-table-column label="ËØÅÊòéÊùêÊñô" width="140" align="center">
            <template v-slot="scope">
              <el-dropdown trigger="click" @command="handleFileCommand" @click.native.stop :disabled="!scope.row.proofMaterial || scope.row.proofMaterial.length === 0">
                <el-button type="primary" size="mini" plain @click.stop :disabled="!scope.row.proofMaterial || scope.row.proofMaterial.length === 0">
                  <i class="el-icon-document"></i> ÂõæÁâáÊìç‰Ωú
                </el-button>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item
                    :command="{ action: 'preview', files: scope.row.proofMaterial }"
                    :disabled="!scope.row.proofMaterial"
                  >
                    <i class="el-icon-view"></i>È¢ÑËßà
                  </el-dropdown-item>
                  <el-dropdown-item
                    :command="{ action: 'download', files: scope.row.proofMaterial }"
                    :disabled="!scope.row.proofMaterial"
                  >
                    <i class="el-icon-download"></i>‰∏ãËΩΩ
                  </el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </template>
          </el-table-column>

          <!-- ÂÆ°Ê†∏Áä∂ÊÄÅ -->
          <el-table-column prop="auditStatus" label="ÂÆ°Ê†∏Áä∂ÊÄÅ" width="120" align="center">
            <template v-slot="scope">
              <el-tag
                :type="getStatusTagType(scope.row.auditStatus)"
                effect="light"
                class="status-tag"
              >
                <i :class="getStatusIcon(scope.row.auditStatus)"></i>
                {{ scope.row.auditStatus }}
              </el-tag>
            </template>
          </el-table-column>

          <!-- Êìç‰ΩúÂàó -->
          <el-table-column label="Êìç‰Ωú" width="100" align="center">
            <template v-slot="scope">
              <template v-if="scope.row.auditStatus === 'Êú™ÈÄöËøá'">
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleEditDraft(scope.row)"
                >ÈáçÊñ∞Êèê‰∫§
                </el-button>
              </template>

              <template v-if="scope.row.auditStatus === 'Êú™Êèê‰∫§'">
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleEditDraft(scope.row)"
                >ÁºñËæë
                </el-button>
                <el-button
                  type="text"
                  size="mini"
                  style="color: #F56C6C;"
                  @click.stop="handleDelete(scope.row)"
                >Âà†Èô§
                </el-button>
              </template>

              <el-tag
                v-if="['Êú™ÂÆ°Ê†∏', 'Â∑≤ÈÄöËøá'].includes(scope.row.auditStatus)"
                type="info"
                size="mini"
                class="no-edit-tag"
              >‰∏çÂèØ‰øÆÊîπ
              </el-tag>
            </template>
          </el-table-column>

          <!-- ÂÆ°Ê†∏Êó∂Èó¥ -->
          <el-table-column prop="auditTime" label="ÂÆ°Ê†∏Êó∂Èó¥" width="140" align="center">
            <template v-slot="scope">
              <span class="time-display">
                {{ formatDateTime(scope.row.auditTime) }}
              </span>
            </template>
          </el-table-column>

          <!-- ÂÆ°Ê†∏ÊÑèËßÅ -->
          <el-table-column prop="auditRemark" label="ÂÆ°Ê†∏ÊÑèËßÅ" min-width="160" align="center">
            <template v-slot="scope">
              <div class="remark-text">
                {{ scope.row.auditRemark || '-' }}
              </div>
            </template>
          </el-table-column>
        </el-table>

        <!-- ÂàÜÈ°µ -->
        <pagination
          v-show="totalRecords>0"
          :total="totalRecords"
          :page.sync="currentPage"
          :limit.sync="pageSize"
          @pagination="fetchActivityRecords"
          class="custom-pagination"
        />
      </div>
    </div>

    <!-- ÂõæÁâáÈ¢ÑËßàÂØπËØùÊ°Ü -->
    <el-dialog :visible.sync="previewVisible" title="ÂõæÁâáÈ¢ÑËßà" width="60%">
      <div style="text-align: center; margin-bottom: 20px;">
        <img
          :src="previewImages[currentPreviewIndex]"
          style="max-width: 100%; display: block; margin: 0 auto;"
          alt="ËØÅÊòéÊùêÊñôÈ¢ÑËßà"
        />
        <el-button
          icon="el-icon-arrow-left"
          :disabled="currentPreviewIndex === 0"
          @click="currentPreviewIndex--"
        ></el-button>
        <span style="margin: 0 20px;">{{ currentPreviewIndex + 1 }} / {{ previewImages.length }}</span>
        <el-button
          icon="el-icon-arrow-right"
          :disabled="currentPreviewIndex === previewImages.length - 1"
          @click="currentPreviewIndex++"
        ></el-button>
      </div>

      <div slot="footer">
        <el-button
          type="primary"
          @click="downloadSingleFile(previewImages[currentPreviewIndex])"
          style="background-color: #42b983; border-color: #42b983;"
        >
          <i class="el-icon-download"></i> ‰∏ãËΩΩÂΩìÂâçÂõæÁâá
        </el-button>
      </div>
    </el-dialog>

    <!-- Ê¥ªÂä®Êñ∞Â¢ûÂØπËØùÊ°Ü -->
    <el-dialog
      :visible.sync="showDialog"
      title="Ê¥ªÂä®‰ø°ÊÅØÂ°´Êä•"
      width="580px"
      class="activity-dialog"
      @close="closeDialog"
    >
      <div class="dialog-header">
        <h3 class="form-title">{{ isEdit ? 'ÁºñËæëÊ¥ªÂä®ËÆ∞ÂΩï' : 'Êñ∞Â¢ûÊ¥ªÂä®ËÆ∞ÂΩï' }}</h3>
        <p class="form-tips">ËØ∑Â°´ÂÜôÊú¨Â≠¶ÊúüÂèÇ‰∏éÁöÑÊ¥ªÂä®‰ø°ÊÅØÔºàÂ∏¶<span class="required">*</span>‰∏∫ÂøÖÂ°´È°πÔºâ</p>
      </div>

      <el-form
        ref="form"
        :model="formData"
        :rules="rules"
        label-width="110px"
        class="activity-form"
      >
        <!-- Ê¥ªÂä®ÂêçÁß∞ -->
        <el-form-item label="Ê¥ªÂä®ÂêçÁß∞" prop="activityName">
          <el-input
            v-model="formData.activityName"
            placeholder="ËØ∑ËæìÂÖ•ÂÆåÊï¥Ê¥ªÂä®ÂêçÁß∞"
            class="custom-input"
          >
            <i slot="prefix" class="el-icon-star-on name-icon"></i>
          </el-input>
        </el-form-item>

        <!-- Ê¥ªÂä®Á∫ßÂà´ -->
        <el-form-item label="Ê¥ªÂä®Á∫ßÂà´" prop="activityLevel">
          <el-select
            v-model="formData.activityLevel"
            placeholder="ËØ∑ÈÄâÊã©Á∫ßÂà´"
            class="custom-select"
          >
            <el-option
              v-for="item in levelOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            >
              <span class="option-icon">{{ levelIcons[item.value] }}</span>
              {{ item.label }}
            </el-option>
          </el-select>
        </el-form-item>

        <!-- Ëé∑Â•ñÁ≠âÁ∫ß -->
        <el-form-item label="Ëé∑Â•ñÁ≠âÁ∫ß" prop="awardLevel">
          <el-select
            v-model="formData.awardLevel"
            placeholder="ËØ∑ÈÄâÊã©Â•ñÈ°π"
            class="custom-select"
          >
            <el-option
              v-for="item in awardOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            >
              <span class="option-icon">{{ awardIcons[item.value] }}</span>
              {{ item.label }}
            </el-option>
          </el-select>
        </el-form-item>

        <!-- Ëé∑Â•ñÊó•Êúü -->
        <el-form-item label="Ëé∑Â•ñÊó•Êúü" prop="awardDate">
          <el-date-picker
            v-model="formData.awardDate"
            type="date"
            value-format="yyyy-MM-dd"
            placeholder="ÈÄâÊã©Êó•Êúü"
            class="custom-date"
            :picker-options="pickerOptions"
          >
            <i slot="suffix" class="el-icon-date date-icon"></i>
          </el-date-picker>
        </el-form-item>

        <!-- ËØÅÊòéÊùêÊñô -->
        <el-form-item label="ËØÅÊòéÊùêÊñô" prop="proofMaterial">
          <el-upload
            multiple
            :limit="5"
            :file-list="fileList"
            :auto-upload="false"
            :on-change="handleFileChange"
            :on-remove="handleFileRemove"
            :on-preview="handlePreviewFile"
            list-type="picture-card"
            class="custom-upload"
          >
            <i class="el-icon-plus"></i>
            <div slot="tip" class="el-upload__tip">ÊîØÊåÅÊ†ºÂºèÔºöJPG/PNG ÂçïÊñá‰ª∂‚â§10MB ÊúÄÂ§ö5‰∏™Êñá‰ª∂</div>
          </el-upload>
        </el-form-item>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <el-form-item class="form-actions">
          <el-button
            type="info"
            class="save-btn"
            @click="handleSave"
          >
            <i class="el-icon-document"></i> ‰øùÂ≠òËçâÁ®ø
          </el-button>
          <el-button
            type="primary"
            class="submit-btn"
            @click="handleSubmit"
          >
            <i class="el-icon-check"></i> Ê≠£ÂºèÊèê‰∫§
          </el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>

</template>

<script>
import {listActivity, addActivity, updateActivity, delActivity, checkActivityUnique} from "@/api/system/activity";
import ImageUpload from '@/components/ImageUpload';
import axios from "axios";
import store from "@/store";

export default {
  mounted() {
    // Ëé∑ÂèñÂ≠¶ÊúüÂèÇÊï∞
    this.activeSemester = this.$route.query.semester;
    //ÂæóÂà∞ÂàóË°®Êï∞ÊçÆ
    this.fetchActivityRecords();
  },
  components: {
    ImageUpload
  },
  data() {
    return {
      allowedImageTypes: ['image/jpg', 'image/png','image/jpeg'], // ÂÖÅËÆ∏ÁöÑÊñá‰ª∂Á±ªÂûã
      maxImageSize: 5 * 1024 * 1024, // 5MBÈôêÂà∂
      levelOptions: [
        {value: 'Èô¢Á∫ß', label: 'Èô¢Á∫ß'},
        {value: 'Ê†°Á∫ß', label: 'Ê†°Á∫ß'},
        {value: 'ÁúÅÁ∫ß', label: 'ÁúÅÁ∫ß'},
        {value: 'ÂõΩÂÆ∂Á∫ß', label: 'ÂõΩÂÆ∂Á∫ß'},
        {value: 'ÂõΩÈôÖÁ∫ß', label: 'ÂõΩÈôÖÁ∫ß'}
      ],
      awardOptions: [
        {value: 'ÁâπÁ≠âÂ•ñ', label: 'ÁâπÁ≠âÂ•ñ'},
        {value: '‰∏ÄÁ≠âÂ•ñ', label: '‰∏ÄÁ≠âÂ•ñ'},
        {value: '‰∫åÁ≠âÂ•ñ', label: '‰∫åÁ≠âÂ•ñ'},
        {value: '‰∏âÁ≠âÂ•ñ', label: '‰∏âÁ≠âÂ•ñ'},
        {value: '‰ºòÁßÄÂ•ñ', label: '‰ºòÁßÄÂ•ñ'}
      ],
      levelIcons: {
        'Èô¢Á∫ß': 'üèõÔ∏è',
        'Ê†°Á∫ß': 'üè´',
        'ÁúÅÁ∫ß': 'üåâ',
        'ÂõΩÂÆ∂Á∫ß': 'üá®üá≥',
        'ÂõΩÈôÖÁ∫ß': 'üåç'
      },
      awardIcons: {
        'ÁâπÁ≠âÂ•ñ': 'üèÜ',
        '‰∏ÄÁ≠âÂ•ñ': 'ü•á',
        '‰∫åÁ≠âÂ•ñ': 'ü•à',
        '‰∏âÁ≠âÂ•ñ': 'ü•â',
        '‰ºòÁßÄÂ•ñ': 'üéñÔ∏è'
      },
      pickerOptions: {
        disabledDate(time) {
          return time.getTime() > Date.now();
        }
      },
      fileList: [], // Â∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂ÂàóË°®
      previewVisible: false,
      currentDownloadFile: '',
      previewImages: [],
      currentPreviewIndex: 0,
      isEdit: false,
      currentActivityId: null,
      baseUrl: process.env.VUE_APP_BASE_API,
      activeSemester: "",
      dialogVisible: false,
      currentImage: '',
      activityRecords: [],
      queryParams: {},
      currentPage: 1,
      pageSize: 10,
      totalRecords: 0,
      proofMaterial: [],
      showDialog: false,
      isLoading: false,
      formData: {
        activityName: '',
        activityLevel: '',
        awardLevel: '',
        proofMaterial: '',
        semester: '',
        awardDate: '',
        auditStatus: 'Êú™Êèê‰∫§',
        auditTime: null,
        auditRemark: '',
      },
      rules: {
        activityName: [
          {required: true, message: 'Ê¥ªÂä®ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫', trigger: 'blur'}
        ],
        activityLevel: [
          {required: true, message: 'ËØ∑ÈÄâÊã©Ê¥ªÂä®Á∫ßÂà´', trigger: 'change'}
        ],
        awardLevel: [
          {required: true, message: 'ËØ∑ÈÄâÊã©Â•ñÈ°π', trigger: 'change'}
        ],
        awardDate: [
          {required: true, message: 'ËØ∑ÈÄâÊã©Ëé∑Â•ñÊó•Êúü', trigger: 'change'}
        ]
      }
    };
  },

  methods: {
    headerStyle() {
      return {
        backgroundColor: '#EBF4FF',
        color: '#2B6CB0',
        fontWeight: "600",
      };
    },

    // Êñ∞Â¢ûË°®Ê†ºÁõ∏ÂÖ≥ÊñπÊ≥ï
    getLevelTagType(level) {
      const typeMap = {
        'Èô¢Á∫ß': 'info',
        'Ê†°Á∫ß': 'primary',
        'ÁúÅÁ∫ß': 'success',
        'ÂõΩÂÆ∂Á∫ß': 'warning',
        'ÂõΩÈôÖÁ∫ß': 'danger'
      }
      return typeMap[level] || 'info'
    },

    getAwardTagType(award) {
      const typeMap = {
        'ÁâπÁ≠âÂ•ñ': 'danger',
        '‰∏ÄÁ≠âÂ•ñ': 'warning',
        '‰∫åÁ≠âÂ•ñ': 'success',
        '‰∏âÁ≠âÂ•ñ': 'primary',
        '‰ºòÁßÄÂ•ñ': 'info'
      }
      return typeMap[award] || ''
    },

    getStatusTagType(status) {
      const typeMap = {
        'Â∑≤ÈÄöËøá': 'success',
        'Êú™ÂÆ°Ê†∏': 'warning',
        'Êú™ÈÄöËøá': 'danger',
        'Êú™Êèê‰∫§': 'info'
      }
      return typeMap[status] || 'info'
    },

    getStatusIcon(status) {
      const iconMap = {
        'Â∑≤ÈÄöËøá': 'el-icon-circle-check',
        'Êú™ÂÆ°Ê†∏': 'el-icon-time',
        'Êú™ÈÄöËøá': 'el-icon-circle-close',
        'Êú™Êèê‰∫§': 'el-icon-edit'
      }
      return iconMap[status] || 'el-icon-question'
    },

    formatDate(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
    },

    formatDateTime(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${this.formatDate(dateString)} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    },

    handleFileCommand(command) {
      if (command.action === 'preview') {
        this.handlePreview(command.files)
      } else if (command.action === 'download') {
        this.downloadFiles(command.files)
      }
    },

    tableRowClassName({rowIndex}) {
      return rowIndex % 2 === 1 ? 'stripe-row' : ''
    },


    // Êñá‰ª∂È¢ÑËßàÂ§ÑÁêÜ
    handlePreviewFile(file) {
      if (file.isOld) {
        // ÊóßÊñá‰ª∂Áõ¥Êé•‰ΩøÁî®Â≠òÂÇ®ÁöÑURL
        window.open(file.url);
      } else {
        // Êñ∞‰∏ä‰º†Êñá‰ª∂‰ΩøÁî®Êú¨Âú∞È¢ÑËßà
        const reader = new FileReader();
        reader.onload = (e) => {
          window.open(e.target.result);
        };
        reader.readAsDataURL(file.raw);
      }
    },
    handleFileRemove(file, fileList) {
      this.fileList = fileList;
    },
    handleFileChange(file, fileList) {
      // È¢ùÂ§ñÂèÇÊï∞Áî®‰∫éÊòæÁ§∫ÈîôËØØÊèêÁ§∫
      const done = (condition, message) => {
        if (!condition) {
          this.$message.error(message)
          // ÁßªÈô§ÈùûÊ≥ïÁöÑÊúÄÂêé‰∏Ä‰∏™Êñá‰ª∂
          const newFiles = fileList.slice(0, fileList.length - 1)
          this.fileList = newFiles.slice(-5)
          return false
        }
        // ‰øùÁïôÂêàÊ≥ïÊñá‰ª∂Âπ∂ÈôêÂà∂ÊúÄÂ§ö5‰∏™
        this.fileList = fileList.slice(-5)
        return true
      }
      console.log("file.raw.type:", file.raw.type)
      // Á±ªÂûãÈ™åËØÅ
      const isValidType = this.allowedImageTypes.includes(file.raw.type)
      if (!isValidType) {
        return done(
          false,
          `‰∏çÊîØÊåÅ ${file.name} ÁöÑÊñá‰ª∂Á±ªÂûãÔºåËØ∑‰∏ä‰º† PNG/JPG Ê†ºÂºèÁöÑÂõæÁâá`
        )
      }

      // Â§ßÂ∞èÈ™åËØÅ
      const isValidSize = file.size <= this.maxImageSize
      if (!isValidSize) {
        return done(false, `Êñá‰ª∂ ${file.name} Ë∂ÖËøá5MBÂ§ßÂ∞èÈôêÂà∂`)
      }

      // Êâ©Â±ïÂêç‰∫åÊ¨°È™åËØÅÔºàÈò≤Ê≠¢‰º™Ë£ÖÊâ©Â±ïÂêçÔºâ
      const fileExt = file.name.split('.').pop().toLowerCase()
      const isValidExt = ['jpg', 'png'].includes(fileExt)
      if (!isValidExt) {
        return done(false, `Êñá‰ª∂ ${file.name} ÁöÑÊâ©Â±ïÂêç‰∏çÂêàÊ≥ï`)
      }
    },
    async downloadFiles(filePaths) {
      try {
        // Ëß£ÊûêÊñá‰ª∂Ë∑ØÂæÑ
        const paths = typeof filePaths === 'string'
          ? JSON.parse(filePaths)
          : filePaths;
        if (!Array.isArray(paths)) {
          throw new Error("Êó†ÊïàÁöÑÊñá‰ª∂Ë∑ØÂæÑÊ†ºÂºè");
        }
        // Â§ÑÁêÜÂ§ö‰∏™Êñá‰ª∂‰∏ãËΩΩ
        if (paths.length >= 1) {
          this.$confirm(`Êú¨Ê¨°‰∏ãËΩΩÂåÖÂê´${paths.length}‰∏™Êñá‰ª∂ÔºåÊòØÂê¶ÁªßÁª≠Ôºü`, 'ÊâπÈáè‰∏ãËΩΩÊèêÁ§∫', {
            confirmButtonText: 'Á´ãÂç≥‰∏ãËΩΩ',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }).then(() => {
            paths.forEach(path => {
              const url = this.getFullUrl(path); // ‰ΩøÁî® getFullUrl ÊñπÊ≥ïÁîüÊàêÂÆåÊï¥ URL
              this.downloadSingleFile(url);
            });
          });
        }
      } catch (error) {
        this.$message.error(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`);
        console.error("‰∏ãËΩΩÈîôËØØËØ¶ÊÉÖ:", error);
      }
    },
// ‰∏ãËΩΩÂçï‰∏™Êñá‰ª∂
    async downloadSingleFile(filePath) {
      try {
        const response = await axios.get(
          filePath,
          {
            responseType: 'blob',
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token")
            }
          }
        );
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', this.generateFileName(filePath));
        document.body.appendChild(link);
        link.click();
        URL.revokeObjectURL(url);
        link.remove();
      } catch (error) {
        this.$message.error(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`);
      }
    },

    handlePreview(filePath) {
      try {
        const paths = typeof filePath === 'string'
          ? JSON.parse(filePath)
          : filePath;

        if (paths.length > 0) {
          this.previewImages = paths.map(path => this.getFullUrl(path));
          this.currentPreviewIndex = 0;
          this.currentDownloadFile = paths[0];
          this.previewVisible = true;
        }
      } catch (error) {
        console.error('È¢ÑËßàÂ§±Ë¥•:', error);
        this.$message.error('È¢ÑËßàÂ§±Ë¥•ÔºöÊñá‰ª∂Ë∑ØÂæÑÊ†ºÂºè‰∏çÊ≠£Á°Æ');
      }
    },
    // Êñ∞Â¢ûËé∑ÂèñÂÆåÊï¥URLÁöÑÊñπÊ≥ï
    getFullUrl(filePath) {
      return `${process.env.VUE_APP_BASE_API}/profile/${filePath}`;
    },


    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    closeDialog() {
      this.showDialog = false;
      this.fileList = []; // Ê∏ÖÁ©∫Â∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂ÂàóË°®
    },
    // Âà†Èô§Â§ÑÁêÜÊñπÊ≥ï
    async handleDelete(row) {
      try {
        await this.$confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ËçâÁ®øËÆ∞ÂΩïÂêóÔºü', 'Âà†Èô§Á°ÆËÆ§', {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        });

        const response = await delActivity(row.activityId); // Ê†πÊçÆÂÆûÈôÖIDÂ≠óÊÆµË∞ÉÊï¥
        if (response.code === 200) {
          this.$message.success('Âà†Èô§ÊàêÂäü');
          // Âà†Èô§ÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
          await this.fetchActivityRecords();
          // Ê∏ÖÁêÜÊú¨Âú∞ËçâÁ®ø
          if (!row.id) { // ÂÅáËÆæidÂ≠òÂú®Ë°®Á§∫Â∑≤‰øùÂ≠òÂà∞ÊúçÂä°Á´Ø
            localStorage.removeItem(this.getDraftKey());
          }
        }
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error(`Âà†Èô§Â§±Ë¥•: ${error.message || 'ÊúçÂä°Âô®ÈîôËØØ'}`);
        }
      }
    },
    // Ëé∑ÂèñÂÆåÊï¥ÂõæÁâáË∑ØÂæÑ
    getImageUrl(path) {
      if (!path) return '';
      // Â§ÑÁêÜ‰∏§ÁßçË∑ØÂæÑÊÉÖÂÜµÔºö
      // 1. ÂÆåÊï¥Ë∑ØÂæÑÁõ¥Êé•ËøîÂõû
      // 2. Áõ∏ÂØπË∑ØÂæÑÊãºÊé•Âü∫Á°ÄURL
      return path.startsWith('http')
        ? `${path}?t=${Date.now()}`  // Ê∑ªÂä†Êó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
        : `${this.baseUrl}${path}?t=${Date.now()}`;
    },

    handleImageClick(imageUrl) {
      this.currentImage = imageUrl;
      this.dialogVisible = true;
    },

    // ‰∏ãËΩΩÂõæÁâá
    handleDownload() {
      if (!this.currentImage) {
        this.$message.warning('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÂõæÁâá');
        return;
      }

      const link = document.createElement('a');
      link.href = this.getImageUrl(this.currentImage);
      link.download = this.generateFileName();
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    },

    // ÁîüÊàêÂ∏¶Êó∂Èó¥Êà≥ÁöÑÊñá‰ª∂Âêç
    generateFileName() {
      const date = new Date().toISOString().slice(0, 10);
      const ext = this.getFileExtension();
      return `activity_${date}_${Math.random().toString(36).substr(2, 5)}.${ext}`;
    },

    // Ëé∑ÂèñÊñá‰ª∂Êâ©Â±ïÂêç
    getFileExtension() {
      try {
        return this.currentImage.split('.').pop().split(/[#?]/)[0] || 'jpg';
      } catch {
        return 'jpg';
      }
    },

    // Êï∞ÊçÆËé∑ÂèñÊñπÊ≥ï
    async fetchActivityRecords() {
      this.isLoading = true;
      try {
        const params = {
          pageNum: this.currentPage,
          pageSize: this.pageSize,
          studentId: this.$store.state.user.name,
          semester: this.activeSemester,
          ...this.queryParams
        };

        const response = await listActivity(params);
        if (response.code === 200) {
          // Â§ÑÁêÜËØÅÊòéÊùêÊñôË∑ØÂæÑ
          this.activityRecords = response.rows.map(item => ({
            ...item,
            id: item.activityId,
            auditStatus: item.auditStatus,
            proofMaterial: this.parseMaterial(item.proofMaterial)
          }));
          this.totalRecords = response.total;
        }
      } catch (error) {
        console.error("Ëé∑ÂèñÊ¥ªÂä®ËÆ∞ÂΩïÂ§±Ë¥•:", error);
      } finally {
        this.isLoading = false;
      }
    },

    // ÂàÜÈ°µÂ§ÑÁêÜ
    handleSizeChange(size) {
      this.pageSize = size;
      this.fetchActivityRecords();
    },

    handleCurrentChange(page) {
      this.currentPage = page;
      this.fetchActivityRecords();
    },
    initFormData() {
      return {
        activityName: '',
        activityLevel: '',
        awardLevel: '',
        proofMaterial: '',
        semester: this.activeSemester,
        awardDate: '',
        auditTime: null,
        auditRemark: '',
        auditStatus: 'Êú™Êèê‰∫§'
      };
    },
    // ÂØπËØùÊ°ÜÊéßÂà∂
    openDialog() {
      this.isEdit = false;
      this.currentActivityId = null;
      this.formData = this.initFormData(); // ‰ΩøÁî®ÂàùÂßãÂåñÊñπÊ≥ï
      this.showDialog = true;
    },

// ‰øÆÊîπÂêéÁöÑparseMaterialÊñπÊ≥ï
    parseMaterial(material) {
      try {
        // ÊÉÖÂÜµ1ÔºöÂ∑≤ÁªèÊòØÊï∞ÁªÑÁõ¥Êé•ËøîÂõû
        if (Array.isArray(material)) {
          console.log('[DEBUG] Â∑≤Ëß£Êûê‰∏∫Êï∞ÁªÑ:', material);
          return [...material]; // Ëß£Èô§ÂìçÂ∫îÂºèÁªëÂÆö
        }

        // ÊÉÖÂÜµ2ÔºöÂ≠óÁ¨¶‰∏≤Á±ªÂûãÂ∞ùËØïËß£Êûê
        if (typeof material === 'string') {
          // Â§ÑÁêÜVueÂìçÂ∫îÂºèÂØπË±°Â≠óÁ¨¶‰∏≤ÁöÑÁâπÊÆäÊÉÖÂÜµ
          const cleaned = material.replace(/__ob__:.*?($$|$$)/gs, '');
          console.log('[DEBUG] Â∑≤Ëß£Êûê‰∏∫Â≠óÁ¨¶‰∏≤:', cleaned);
          return JSON.parse(cleaned);
        }

        // ÊÉÖÂÜµ3ÔºöÂÖ∂‰ªñÁ±ªÂûãËøîÂõûÁ©∫Êï∞ÁªÑ
        return [];
      } catch (e) {
        console.error('ÊùêÊñôËß£ÊûêÂ§±Ë¥•:', {
          input: material,
          error: e.stack
        });
        return [];
      }
    },
    handleEdit(row) {
      // ÂàõÂª∫Ê∑±Êã∑Ë¥ùÈÅøÂÖçÂìçÂ∫îÂºèÊï∞ÊçÆÈóÆÈ¢ò
      const rawData = JSON.parse(JSON.stringify(row));
      this.formData = {...rawData};
      this.isEdit = true;
      this.currentActivityId = rawData.activityId;
      this.showDialog = true;

      // Ëß£ÊûêÊñá‰ª∂Ë∑ØÂæÑ
      const proofMaterial = this.parseMaterial(rawData.proofMaterial);

      // ÁîüÊàêÁ¨¶Âêàel-uploadË¶ÅÊ±ÇÁöÑÊñá‰ª∂ÂàóË°®
      this.fileList = proofMaterial.map((path, index) => {
        // Ë∑ØÂæÑÊúâÊïàÊÄßÈ™åËØÅ
        if (!path || typeof path !== 'string') {
          console.warn(`Êó†ÊïàÊñá‰ª∂Ë∑ØÂæÑ[${index}]:`, path);
          return null;
        }

        // ÁîüÊàêÂÆåÊï¥ËÆøÈóÆURL
        const fullUrl = `${process.env.VUE_APP_BASE_API}/profile/${encodeURIComponent(path)}`;

        return {
          uid: Date.now() + index, // ÂîØ‰∏ÄÊ†áËØÜ
          name: path.split('/').pop(),
          url: fullUrl,
          status: 'success',
          isOld: true,
          path: path
        };
      }).filter(Boolean);

      console.log('[DEBUG] ÁîüÊàêÁöÑÊñá‰ª∂ÂàóË°®:', this.fileList);
    },

    // Â§ÑÁêÜËçâÁ®ø‰øÆÊîπ
    handleEditDraft(row) {
      this.handleEdit(row);
      localStorage.removeItem(this.getDraftKey());
    },
    // ‰øùÂ≠òËçâÁ®ø
    async handleSave() {
      await this.submitData('Êú™Êèê‰∫§');
    },

    // Ê≠£ÂºèÊèê‰∫§
    async handleSubmit() {
      await this.submitData('Êú™ÂÆ°Ê†∏');
    },

    // Áªü‰∏ÄÊèê‰∫§ÊñπÊ≥ï
    async submitData(status) {
      this.$refs.form.validate(async (valid) => {
        if (valid) {
          // Ëé∑ÂèñÂéüÂßãËÆ∞ÂΩïÊï∞ÊçÆÔºàÁºñËæëÊó∂Ôºâ
          const originalRecord = this.activityRecords.find(
            item => item.id === this.currentActivityId
          );
          console.log("this.currentActivityId:" + this.currentActivityId)
          // Ê£ÄÊµãÂÖ≥ÈîÆÂ≠óÊÆµÊòØÂê¶‰øÆÊîπ
          const isKeyFieldChanged = !originalRecord ||
            this.formData.activityName !== originalRecord.activityName ||
            this.formData.activityLevel !== originalRecord.activityLevel ||
            this.formData.awardLevel !== originalRecord.awardLevel;
          console.log("isKeyFieldChanged:" + isKeyFieldChanged)
          console.log("this.currentActivityId:" + this.currentActivityId)
          const shouldCheckUnique = !this.currentActivityId || isKeyFieldChanged;

          // ÁºñËæëÊó∂ÊéíÈô§Ëá™Ë∫´
          if (shouldCheckUnique) {
            // ÂîØ‰∏ÄÊÄßÊ†°È™åÂèÇÊï∞
            const checkParams = {
              studentId: this.$store.state.user.name,
              activityName: this.formData.activityName,
              activityLevel: this.formData.activityLevel,
              awardLevel: this.formData.awardLevel,
              semester: this.activeSemester
            };
            // ÊâßË°åÂîØ‰∏ÄÊÄßÊ†°È™å
            const checkRes = await checkActivityUnique(checkParams);
            if (checkRes.code !== 200) {
              return this.$message.error('Â∑≤Â≠òÂú®Áõ∏ÂêåÊ¥ªÂä®ËÆ∞ÂΩïÔºå‰∏çÂèØÈáçÂ§çÊ∑ªÂä†');
            }
          }

          // Ëé∑Âèñ‰øùÁïôÁöÑÊóßÊñá‰ª∂Ë∑ØÂæÑ
          const existingPaths = this.fileList
            .filter(file => file.isOld)
            .map(file => file.path);

          // Ëé∑ÂèñÊñ∞‰∏ä‰º†ÁöÑÊñá‰ª∂
          const newFiles = this.fileList
            .filter(file => !file.isOld)
            .map(file => file.raw);

          const formData = new FormData();
          // ÊûÑÂª∫Ê†∏ÂøÉÊï∞ÊçÆÂØπË±°
          const recordData = {
            activityId: null,
            activityName: this.formData.activityName,
            activityLevel: this.formData.activityLevel,
            awardLevel: this.formData.awardLevel,
            semester: this.activeSemester,
            studentId: store.state.user.name,
            auditStatus: status,
            auditTime: null,
            auditRemark: '',
            awardDate: this.formData.awardDate,
            existingProofMaterial: existingPaths, // ÊóßÊñá‰ª∂Ë∑ØÂæÑ
          };

          // Â¶ÇÊûúÊòØÁºñËæëÊìç‰ΩúÔºåÊ∑ªÂä†IDÂ≠óÊÆµ
          if (this.currentActivityId) {
            recordData.activityId = this.currentActivityId;
          }
          // ÊûÑÂª∫ JSON ÈÉ®ÂàÜÔºàÊåáÂÆöÁ±ªÂûã‰∏∫ application/jsonÔºâ
          const recordBlob = new Blob(
            [JSON.stringify(recordData)],
            {type: "application/json"}
          );
          formData.append("stuActivityRecord", recordBlob);

          // Ê∑ªÂä†Êñá‰ª∂
          this.fileList.forEach((file) => {
            formData.append("proofMaterial", file.raw);
          });

          // ÈÖçÁΩÆheaders
          const config = {
            headers: {
              "Authorization": "Bearer " + localStorage.getItem("token"),
              "Content-Type": "multipart/form-data"
            }
          };
          // Ê†πÊçÆÊ®°ÂºèÈÄâÊã©APIÊñπÊ≥ï
          const apiMethod = this.currentActivityId ? updateActivity : addActivity;
          apiMethod(formData, config)
            .then(() => {
              this.$message.success(this.currentActivityId ? "Êõ¥Êñ∞ÊàêÂäüÔºÅ" : "Êèê‰∫§ÊàêÂäüÔºÅ");
              this.fetchActivityRecords();
              this.closeDialog();
            })
            .catch(error => {
              this.$message.error(`Êìç‰ΩúÂ§±Ë¥•Ôºö${error.message}`);
            });
        }
      });
    },
    // Ëé∑ÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑkey
    getDraftKey() {
      return `activity_draft_${this.$store.state.user.name}_${this.activeSemester}`;
    },
  }
};
</script>

<style scoped>
/* ================= ÂÖ®Â±ÄÂÆπÂô®Ê†∑Âºè ================= */
.container {
  width: 100%;
  margin: 0 auto;
  padding: 2rem;
  background: linear-gradient(160deg, #EBF4FF 0%, #EBF8FF 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center; /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
}

.main-container {
  background: #ffffff;
  border-radius: 1.5rem;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  padding: 2rem;
  position: relative;
  overflow: hidden;
  width: 100%;
  max-width: 1400px; /* Ê∑ªÂä†ÊúÄÂ§ßÂÆΩÂ∫¶ÈôêÂà∂ */
  margin: 0 auto;     /* Ëá™Âä®Ê∞¥Âπ≥Â±Ö‰∏≠ */
}

/* ================= ÂØºËà™Ê†èÊ†∑Âºè ================= */
.nav {
  background: linear-gradient(135deg, #2B6CB0 0%, #4299E1 100%);
  border-radius: 1rem;
  margin: -2rem -2rem 2rem;
  position: relative;
  overflow: hidden;
}

.nav::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg,
  rgba(255, 255, 255, 0.1) 25%,
  transparent 50%,
  rgba(255, 255, 255, 0.1) 75%
  );
  opacity: 0.3;
}

.nav-content {
  padding: 1.5rem 2rem;
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nav h2 {
  color: white;
  font-size: 1.8rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 0;
}

.activity-icon {
  font-size: 1.5em;
  margin-right: 0.5rem;
}

.current-semester {
  font-size: 1.2rem;
  opacity: 0.9;
}
/* ================= Ë°®Ê†ºÁõ∏ÂÖ≥Ê†∑Âºè ================= */
.activity-table-card {
  background: #fff;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  margin-top: 1.5rem;
}

/* Ë°®Ê†ºÂü∫Á°ÄÊ†∑Âºè */
.optimized-table {
  --table-header-bg: #f8fafc;
  --table-hover-bg: #f7fafc;
  --table-stripe-bg: #f8fafc;
  --table-border-color: #e2e8f0;
  --table-text-primary: #2d3748;
  border-radius: 8px;
  overflow: hidden;
}

/* Ë°®Â§¥Ê†∑Âºè */
.optimized-table /deep/ .el-table__header th {
  background: var(--table-header-bg) !important;
  color: #2b6cb0;
  font-weight: 600;
  font-size: 0.95rem;
}

/* Ë°®Ê†ºË°åÊ†∑Âºè */
.optimized-table /deep/ .el-table__body td {
  color: var(--table-text-primary);
  transition: background 0.2s;
  border-color: var(--table-border-color);
}

.optimized-table /deep/ .el-table__body tr:hover td {
  background: var(--table-hover-bg) !important;
  cursor: pointer;
}

.optimized-table /deep/ .stripe-row td {
  background-color: var(--table-stripe-bg);
}

/* Ë°®Ê†ºÂÖÉÁ¥†Ê†∑Âºè */
.index-badge {
  display: inline-flex;
  width: 28px;
  height: 28px;
  background: #ebf4ff;
  border-radius: 50%;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  color: #2b6cb0;
}

.activity-name {
  display: flex;
  align-items: center;
  padding: 8px 0;
  gap: 8px;
}

/* Ê†∏ÂøÉÊ†∑Âºè */
.name-icon {
  /* Â∞∫ÂØ∏ÊîæÂ§ß */
  font-size: 16px !important;  /* ÂéüÂßãÂ∞∫ÂØ∏ÊîæÂ§ß50% */
  transform: scale(1);         /* ÁßªÈô§Áº©ÊîæË°•ÂÅø */

  /* È´òÁ∫ßÊ∏êÂèòËâ≤ */
  background: linear-gradient(45deg, #FFD700 20%, #FFA500 80%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;

  /* ÂÖâÂΩ±ÁªÜËäÇ */
  filter:
    drop-shadow(0 1px 1px rgba(255,215,0,0.15))
    drop-shadow(0 0 2px rgba(255,255,255,0.6));

  /* Âä®Áîª‰ºòÂåñ */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ÊÇ¨ÊµÆÁâπÊïà */
.name-icon:hover {
  filter:
    drop-shadow(0 2px 3px rgba(255,229,92,0.25))
    drop-shadow(0 0 3px rgba(255,255,255,0.8));
  transform: scale(1.1);
}

/* Âä®ÊÄÅËæπÊ°Ü (ÂåπÈÖçÊòüÊòüÂΩ¢Áä∂) */
.name-icon::after {
  content: "";
  position: absolute;
  left: -3px;
  top: -3px;
  width: calc(100% + 6px);
  height: calc(100% + 6px);
  border: 1px solid rgba(255,255,255,0.4);
  clip-path: polygon(
    50% 0%,
    61% 35%,
    98% 35%,
    68% 57%,
    79% 91%,
    50% 70%,
    21% 91%,
    32% 57%,
    2% 35%,
    39% 35%
  ); /* ‰∫îËßíÊòüÂâ™Ë£ÅË∑ØÂæÑ */
}
/* Ê†áÁ≠æÁªü‰∏ÄÊ†∑Âºè */
.level-tag,
.award-tag,
.status-tag {
  border-radius: 12px;
  padding: 0 10px;
  font-weight: 500;
}

/* ================= ÂØπËØùÊ°ÜÊ†∑Âºè ================= */
.activity-dialog {
  border-radius: 12px;
}

.activity-dialog /deep/ .el-dialog__header {
  display: none; /* ÈöêËóèÂéüÁîüÊ†áÈ¢ò */
}

.dialog-header {
  text-align: center;
  padding: 20px 0 15px;
  background: linear-gradient(135deg, #2B6CB0 0%, #4299E1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Ë°®ÂçïÂÖÉÁ¥†Ê†∑Âºè */
.activity-form {
  padding: 0 30px 20px;
}

/* Êìç‰ΩúÊåâÈíÆÊ†∑Âºè */
.form-actions {
  margin-top: 25px;
  text-align: center;
}

/* ================= ÂàÜÈ°µÊ†∑Âºè ================= */
.custom-pagination {
  display: flex;
  justify-content: center !important; /* Âº∫Âà∂Â±Ö‰∏≠ */
  margin: 20px auto 0;
  padding: 12px 0;
  width: 100%;
}

/* Ë∞ÉÊï¥ÂàÜÈ°µÁªÑ‰ª∂ÂÜÖÈÉ®Â∏ÉÂ±Ä */
.custom-pagination /deep/ .el-pagination {
  display: inline-flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
}
/* ÊÇ¨ÂÅúÊïàÊûú */
.custom-pagination /deep/ .el-pager li:hover {
  border-color: #4299e1;
  color: #4299e1;
}


/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
  .custom-pagination {
    padding: 8px;
    justify-content: center;
  }
}

/* ================= ÂìçÂ∫îÂºèËÆæËÆ° ================= */
@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }

  .nav h2 {
    font-size: 1.4rem;
  }
}

</style>
