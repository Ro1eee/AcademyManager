<template>
  <div class="container">
    <div class="main-container">
      <!-- 顶部导航栏增强 -->
      <div class="nav">
        <div class="nav-content">
          <h2>
            <span class="campus-icon">🏫</span>
            书院学生成长档案
          </h2>
          <div class="academic-year">{{ academicPeriod }} 学籍周期</div>
        </div>
      </div>

      <!-- 学期卡片容器 -->
      <div class="semester-grid-wrapper">
        <div class="semester-grid">
          <div
            v-for="(semester, index) in semesters"
            :key="index"
            class="semester-card"
            :class="[semester.status, {
            'active': activeIndex === index,
            'disabled': semester.status === 'future'
            }]"
            @click="handleCardClick(index)"
          >

            <div class="glow-effect"></div>
            <div class="semester-header">
              <span class="semester-name">{{ semester.name }}</span>
              <span class="time">{{ semester.time }}</span>
            </div>
            <div class="progress-wrapper">
              <div class="progress">
                <div
                  class="progress-bar"
                  :style="{ width: semester.progress + '%',
                            background: progressColor(semester)}"
                >
                  <span class="progress-text">{{ semester.progress }}%</span>
                </div>
              </div>
            </div>
            <div class="status-indicator">
              <span v-if="semester.status === 'completed'">✅ 已完成</span>
              <span v-if="semester.status === 'current'" class="blink">🎯 进行中</span>
              <span v-if="semester.status === 'future'">⏳ 未开启</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 展开的模块面板 -->
    <transition name="panel">
      <div
        v-if="activeIndex !== null"
        class="module-panel"
        :style="panelPosition"
      >
        <div class="panel-header">
          <h3>{{ currentSemester.name }}成长记录</h3>
          <span class="gpa">GPA: {{ currentSemester.gpa || '--' }}</span>
          <button class="close-btn" @click.stop="closePanel">×</button>
        </div>

        <div class="module-list">
          <div
            v-for="(module, key) in modules"
            :key="key"
            class="module-item"
            @click="handleModuleClick(key)"
          >
            <div class="module-icon">
              {{ module.icon }}
            </div>
            <div class="module-info">
              <h4>{{ module.label }}</h4>
              <p>{{ currentSemester.stats[key] }}</p>
            </div>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<script>
export default {
  data() {
    return {
      activeIndex: null,
      panelTop: 0,
      semesters: [], // 改为动态生成
      modules: {
        score: { label: '学业成绩', icon: '📊' },
        competition: { label: '科创竞赛', icon: '🏆' },
        activity: { label: '文体活动', icon: '🎭' },
        report: { label: '讲座报告', icon: '📝' },
        meeting: { label: '导师指导', icon: '👥' }
      }
    }
  },
  computed: {
    currentSemester() {
      return this.semesters[this.activeIndex] || {}
    },
    panelPosition() {
      return { top: this.panelTop + 'px' }
    },
    admissionYear() {
      return this.$store.state.user.name.substring(0, 4)
    },
    academicPeriod() {
      const start = parseInt(this.admissionYear)
      return `${start}-${start + 4}`
    }
  },
  created() {
    this.semesters = Array.from({ length: 8 }, (_, index) => {
      const status = this.determineStatus(index)
      return {
        name: `大${['一','二','三','四'][Math.floor(index/2)]}${index%2 ? '下' : '上'}`,
        time: this.generateSemesterTime(index),
        progress: this.calculateProgress(index),
        status: status,
        gpa: this.getDefaultGPA(status),
        stats: this.generateDefaultStats(status)
      }
    })
  },
  methods: {
    // 修改点击处理方法
    handleCardClick(index) {
      if (this.semesters[index].status === 'future') {
        this.$message.warning('该学期尚未开启，请等待');
        return;
      }
      this.togglePanel(index);
    },
    generateSemesterTime(index) {
      const baseYear = parseInt(this.admissionYear);
      const academicYearOffset = Math.floor(index / 2);
      const isFirstSemester = index % 2 === 0;

      // 上学期（9月-次年1月）
      if (isFirstSemester) {
        const startYear = baseYear + academicYearOffset;
        return `${startYear}.09-${startYear + 1}.01`;
      }
      // 下学期（3月-7月）
      else {
        const startYear = baseYear + academicYearOffset + 1;
        return `${startYear}.03-${startYear}.07`;
      }
    },
    determineStatus(index) {
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth() + 1;

      // 解析学期开始年份
      const [startStr] = this.generateSemesterTime(index).split('-');
      const startYear = parseInt(startStr.split('.')[0]);

      // 状态判断逻辑
      if (startYear < currentYear) return 'completed';
      if (startYear > currentYear) return 'future';

      // 同年度学期判断
      const isFirstSemester = index % 2 === 0;
      if (isFirstSemester) {
        // 上学期（9月-次年1月）
        const isCurrent = currentMonth >= 9 || (currentMonth <= 1 && currentYear === startYear + 1);
        return isCurrent ? 'current' : 'future';
      } else {
        // 下学期（3月-7月）
        const isCurrent = currentMonth >= 3 && currentMonth <= 7;
        return isCurrent ? 'current' : 'future';
      }
    },
    calculateProgress(index) {
      const status = this.determineStatus(index);
      if (status !== 'current') return status === 'completed' ? 100 : 0;

      // 获取学期时间段
      const [startStr, endStr] = this.generateSemesterTime(index).split('-');
      const [startYear, startMonth] = startStr.split('.').map(Number);
      const [endYear, endMonth] = endStr.split('.').map(Number);

      // 获取当前日期
      const current = new Date();
      const currentYear = current.getFullYear();
      const currentMonth = current.getMonth() + 1; // 1-12

      // 计算学期总月数（固定4个月）
      const totalMonths = 4;

      // 计算已过月份（基于学期开始时间）
      let elapsedMonths = 0;

      // 处理上学期（9月-次年1月）
      if (startMonth === 9) {
        elapsedMonths = currentMonth >= 9 ? currentMonth - 9 + 1 : 0;
        if (currentYear > startYear && currentMonth <= 1) {
          elapsedMonths = 5 - (1 - currentMonth); // 处理跨年1月
        }
      }
      // 处理下学期（3月-7月）
      else if (startMonth === 3) {
        elapsedMonths = Math.max(currentMonth - 3 + 1, 0);
      }

      // 计算进度百分比（每月25%）
      let progress = Math.min(elapsedMonths, totalMonths) * 25;

      // 处理学期结束后的进度
      if (currentMonth > endMonth && currentYear >= endYear) {
        progress = 100;
      }

      return Math.min(progress, 100);
    },

    getDefaultGPA(status) {
      return status === 'future' ? null : Number((Math.random() * 0.8 + 3.0).toFixed(1))
    },
    generateDefaultStats(status) {
      const defaults = {
        score: '--',
        competition: '（未开始）',
        activity: '（未开始）',
        report: '（未开始）',
        meeting: '（未开始）'
      }
      if (status === 'future') return defaults

      return {
        score: `${Math.floor(Math.random()*5)}门优秀`,
        competition: ['参与','入围','获奖'][Math.floor(Math.random()*3)],
        activity: `${Math.floor(Math.random()*8)}次活动`,
        report: `${Math.floor(Math.random()*6)}场报告`,
        meeting: `${Math.floor(Math.random()*10)}次会议`
      }
    },
    togglePanel(index) {
      this.activeIndex = this.activeIndex === index ? null : index
      this.panelTop = window.innerHeight * 0.3
    },
    closePanel() {
      this.activeIndex = null
    },
    progressColor(semester) {
      const statusColors = {
        completed: 'linear-gradient(90deg, #48bb78 0%, #38a169 100%)',
        current: 'linear-gradient(90deg, #4299e1 0%, #3182ce 100%)',
        future: 'linear-gradient(90deg, #cbd5e0 0%, #a0aec0 100%)'
      }
      return statusColors[semester.status]
    },
    handleModuleClick(key) {
      const routes = {
        score: '/GrowthArchive/StudentScoreShow',
        competition: '/GrowthArchive/CompetitonRecord',
        activity: '/GrowthArchive/ActivityRecord',
        report: '/ReportManagement/index',
        meeting: '/GrowthArchive/MentorshipRecord'
      }
      if (routes[key]) {
        this.$router.push({
          path: routes[key],
          query: { semester: this.currentSemester.name }
        })
      }

      // if (key === 'report') {
      //   this.$router.push({path:'/ReportManagement/index', query: { semester: this.currentSemester.name } })
      // }
      // if (key === 'meeting') {
      //   this.$router.push({path:'/GrowthArchive/MentorshipRecord', query: { semester: this.currentSemester.name } })
      // }
    }
  }
}
</script>


<style scoped>
/* 设计系统变量 */
:root {
  --primary: #2B6CB0;
  --secondary: #4299E1;
  --success: #48BB78;
  --info: #718096;
  --surface: #F7FAFC;
  --bg-gradient: linear-gradient(160deg, #EBF4FF 0%, #EBF8FF 100%);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* 基础容器 */
.container {
  background: var(--bg-gradient);
  margin: 0 auto;
  max-width: 100%;
  min-height: 100vh;
  padding: 1rem;
}

.main-container {
  background: #ffffff;
  border-radius: 1.5rem;
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  margin: 0 auto;
  max-width: 1440px;
  overflow: hidden;
  padding: 2rem;
  position: relative;
}

/* 导航栏样式 */
.nav {
  background: linear-gradient(135deg, #2B6CB0 0%, #4299E1 100%);
  border-radius: 1.5rem 1.5rem 0 0;
  box-shadow: var(--shadow-lg);
  margin: -2rem -2rem 2rem;
  overflow: hidden;
  position: relative;
}

.nav::after {
  background: linear-gradient(45deg,
  rgba(255,255,255,0.1) 25%,
  transparent 50%,
  rgba(255,255,255,0.1) 75%
  );
  content: "";
  height: 100%;
  left: 0;
  opacity: 0.3;
  position: absolute;
  top: 0;
  width: 100%;
}

.nav-content {
  align-items: center;
  display: flex;
  gap: 0.5rem;
  justify-content: space-between;
  padding: 1.5rem 2rem;
}

.nav h2 {
  align-items: center;
  color: white;
  display: flex;
  font-size: clamp(1.2rem, 3vw, 2rem);
  gap: 0.5rem;
  margin: 0;
  white-space: nowrap;
}

.campus-icon {
  filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
  font-size: 1.8em;
}

.academic-year {
  color: rgba(255,255,255,0.9);
  font-size: clamp(0.8rem, 1.5vw, 0.9rem);
  white-space: nowrap;
}

/* 学期卡片容器 */
.semester-grid-wrapper {
  overflow-x: hidden;
  padding-bottom: 2rem;
  width: 100%;
}

.semester-grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  margin-top: 1.5rem;
  min-width: auto;
  padding: 0 1rem;
  width: 100%;
}

.semester-card {
  background: var(--surface);
  border-radius: 1rem;
  box-sizing: border-box;
  cursor: pointer;
  height: 100%;
  min-height: 180px;
  overflow: hidden;
  padding: 1.5rem;
  position: relative;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
  box-shadow 0.3s ease;
  width: 100%;
}

/* 卡片状态样式 */
.semester-card.current {
  animation: pulse 2s infinite;
  border-left: 4px solid var(--primary);
}

.semester-card.disabled {
  cursor: not-allowed;
  filter: grayscale(0.8);
  opacity: 0.7;
  overflow: hidden;
  position: relative;
}

.semester-card.disabled::after {
  background: rgba(255,255,255,0.6);
  bottom: 0;
  content: "";
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  z-index: 1;
}

/* 卡片内部元素 */
.glow-effect {
  background: radial-gradient(circle at var(--x) var(--y),
  rgba(66, 153, 225, 0.1) 0%,
  transparent 70%);
  height: 100%;
  left: 0;
  opacity: 0;
  position: absolute;
  top: 0;
  transition: opacity 0.3s;
  width: 100%;
}

.semester-card:hover .glow-effect {
  opacity: 1;
}

.semester-header {
  align-items: center;
  display: flex;
  justify-content: space-between;
  margin-bottom: 1.2rem;
}

.semester-name {
  color: #2D3748;
  font-weight: 600;
}

.time {
  color: var(--info);
  font-size: 0.9rem;
}

/* 进度条相关 */
.progress-wrapper {
  background: rgba(237, 242, 247, 0.6);
  border-radius: 0.5rem;
  margin-top: auto;
  padding: 0.3rem;
}

.progress {
  background: rgba(237, 242, 247, 0.8);
  border-radius: 0.4rem;
  height: 1rem;
  overflow: hidden;
  position: relative;
}

.progress-bar {
  border-radius: 0.4rem;
  height: 100%;
  position: relative;
  transition: background 0.4s ease,
  width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-bar::after {
  background-image: linear-gradient(
    -45deg,
    rgba(255,255,255,0.15) 25%,
    transparent 25%,
    transparent 50%,
    rgba(255,255,255,0.15) 50%,
    rgba(255,255,255,0.15) 75%,
    transparent 75%
  );
  background-size: 1.5rem 1.5rem;
  border-radius: 0.4rem;
  bottom: 0;
  content: "";
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
}

.progress-text {
  color: white;
  font-size: 0.7rem;
  font-weight: 500;
  position: absolute;
  right: 0.5rem;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  top: 50%;
  transform: translateY(-50%);
}

/* 状态指示器 */
.status-indicator {
  align-items: center;
  color: var(--success);
  display: flex;
  font-size: 0.8rem;
  gap: 0.5rem;
  margin-top: 1rem;
}

/* 模块面板 */
.module-panel {
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 1.5rem;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
  left: 50%;
  max-width: 1000px;
  padding: 2rem;
  position: fixed;
  top: 50%;
  transform: translate(-50%, -30%);
  width: 80%;
  z-index: 1000;
}

.panel-header {
  align-items: center;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  margin-bottom: 1.5rem;
  padding-bottom: 1.5rem;
}

.gpa {
  background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
  font-size: 2rem;
  font-weight: 700;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* 模块列表 */
.module-list {
  display: flex;
  gap: 1rem;
  justify-content: space-between;
  overflow: hidden;
}

.module-item {
  cursor: pointer;
  flex: 1;
  flex-shrink: 0;
  max-width: 220px;
  min-width: 160px;
  transition: all 0.3s ease;
}

.module-item:hover {
  box-shadow: 0 16px 24px -6px rgba(66, 153, 225, 0.15);
  transform: translateY(-5px);
}

.module-icon {
  filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1));
  font-size: 2.5rem;
  margin-bottom: 1rem;
  position: relative;
  z-index: 1;
}

.module-info h4 {
  color: #2d3748;
  font-weight: 600;
  margin: 0 0 0.5rem;
}

.module-info p {
  color: #718096;
  font-size: 0.9rem;
  line-height: 1.4;
  margin: 0;
}

/* 关闭按钮 */
.close-btn {
  align-items: center;
  background: rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 50%;
  color: #718096;
  cursor: pointer;
  display: flex;
  font-size: 1.5rem;
  height: 32px;
  justify-content: center;
  transition: all 0.3s ease;
  width: 32px;
}

.close-btn:hover {
  background: var(--primary);
  border-color: transparent;
  color: white;
  transform: rotate(90deg);
}

/* 动画效果 */
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(66,153,225,0.3); }
  100% { box-shadow: 0 0 0 15px rgba(66,153,225,0); }
}

@keyframes blink {
  50% { opacity: 0.5; }
}

.blink {
  animation: blink 1.5s infinite;
}

/* 响应式设计 */
@media (max-width: 1280px) {
  .module-item {
    min-width: 140px;
    padding: 1.2rem;
  }
  .module-icon {
    font-size: 2.2rem;
  }
}

@media (max-width: 1024px) {
  .module-item {
    min-width: 120px;
    padding: 1rem;
  }
  .module-icon {
    font-size: 2rem;
  }
  .module-info h4 {
    font-size: 0.95rem;
  }
}

@media (max-width: 768px) {
  .container {
    padding: 0.5rem;
  }
  .main-container {
    border-radius: 1rem;
    padding: 1rem;
  }
  .nav-content {
    flex-direction: column;
  }
  .semester-grid {
    gap: 1rem;
    grid-template-columns: 1fr;
  }
  .module-panel {
    padding: 1rem;
    width: 95%;
  }
  .module-item {
    min-width: 100px;
    padding: 0.8rem;
  }
  .module-icon {
    font-size: 1.8rem;
  }
  .module-info h4 {
    font-size: 0.85rem;
  }
  .module-info p {
    font-size: 0.8rem;
  }
}

@media (max-width: 480px) {
  .module-item {
    min-width: 80px;
    padding: 0.6rem;
  }
  .module-icon {
    font-size: 1.5rem;
  }
  .module-info h4 {
    font-size: 0.75rem;
  }
}
</style>

